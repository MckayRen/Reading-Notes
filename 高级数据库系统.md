### 高级数据库系统

#### 索引的概念与分类

- 搜索码值、指向具体码值所在记录地址的指针，代表索引结构
- 聚集索引-非聚集索引；稠密索引-稀疏索引；有序索引-散列索引
- 顺序文件索引：文件按搜索码的顺序存储，索引记录按搜索码值排序，叫主索引，也叫聚集索引，对于一个数据表只有一个。可以是稀疏索引，也可以是稠密索引

#### B+树索引

- 多级索引，采用平衡树结构
- 结构：根结点，叶节点，非叶节点
- 插入和删除的时候，B+树的维护



### 查询处理及优化

#### 查询代价的测量方式

- 查询代价：磁盘块传送数量
- 查询处理过程：SQL语句->语法分析（语法树）->初始逻辑查询计划（把语法树转化成关系代数表达式）->优化逻辑查询计划->创建并优化物理查询计划->查询执行引擎->查询结果
- 实现关系操作的基础算法（基于排序，散列，索引的算法）

### 基于锁的协议

#### 锁

- 共享锁 排它锁

#### 两阶段锁协议

所有事务分为两个阶段提出加锁和解锁请求

- 增长阶段：事务可以获得锁，但不能解锁
- 加锁点
- 缩减阶段：事务解锁，但不能获得锁

严格两阶段协议不允许释放排它锁，强两阶段协议不允许释放共享锁和排它锁

#### 多粒度锁及意向锁

#### 多粒度树

- 显示加锁：树上每个结点都可以单独加锁
- 隐式加锁：对当前结点加锁会导致隐式地对全部后代节点加上同类型的锁
- 意向锁：一个事务对一个数据对象显示加锁之前，必须对它的全部祖先结点加意向锁
- 意向锁分类：Intent Share Lock;Intent Exclusive Lock;Share Intent Exclusive Lock(S+IX)

锁类型的相容矩阵：

|  🔒   |  X   | SIX  |  S   |  IX  |  IS  |
| :--: | :--: | :--: | :--: | :--: | :--: |
|  X   |  N   |  N   |  N   |  N   |  N   |
| SIX  |  N   |  N   |  N   |  N   |  Y   |
|  S   |  N   |  N   |  Y   |  N   |  Y   |
|  IX  |  N   |  N   |  N   |  Y   |  Y   |
|  IS  |  N   |  Y   |  Y   |  Y   |  Y   |

- 可串行行多粒度锁协议
  - 必须遵守锁类型的相容性矩阵
  - 根结点必须首先加锁
  - 任何事务都必须遵守两阶段锁协议
- 多粒度锁协议的优点：增加并行性，减少锁开销

####死锁的预防

- 抢占与事务回滚技术
  - 基本措施：每一个事务赋予一个时间戳。若一个事务回滚，则当重启该事务时，必须保持原时间戳。然后采用以下机制：
    - wait-die：如果T1申请的数据被T2持有时，则只有：T1>T2（T1年轻）时，T1等待，否则回滚
    - wound-wait：与前面的条件相同时，只有T1<T2时，T1等待，否则回滚
  - 基于超时的机制：事先给出事务的等待的时间，超时则回滚

#### 死锁的处理

- 死锁的检验：等待图。图内有环，则有死锁
- 从死锁中恢复：选择事务回滚
  - 选择代价最小的事务